\documentclass[a4paper,10pt]{article}
\usepackage[empty]{fullpage}
\usepackage[english]{babel}
\usepackage{listings}
\usepackage{hyperref}
\usepackage{multirow}

\title{ADDIS excel/table study data interchange format}
\author{J.J. de Keijser, D.A.P. Reid}
\date{today\\v1.0}
\begin{document}
\maketitle
\section{Summary}

This document describes the required structure for an Excel file to be a valid document for import to the ADDIS study data repository. The format aims to be a compromise between human- and machine-readability.
Fixed headers are shown in \textbf{bold}.\\
References are shown in \textit{italic} e.g. `=Concepts!B2'.\\
Fields marked by a * show the source of the data of exported files, and are ignored when importing.

\section{ADDIS study export}
An example Excel study file is available at \url{https://drugis.org/files/excelStudyExample.xlsx}. We recommend keeping it open while reading this document for reference.\\ 
The following sections each explain one sheet of the document.

\subsection{Study Data}
The Study Data sheet stores meta-data about the study, its arm structure, and the measurements that were reported for each variable and measurement moment.

Since this sheet is large and complex, we explain it block by block, with each `block' corresponding to one of the headers in the first row of the sheet. We discuss the block moving from left to right.

\subsubsection{Study Information}
The \texttt{Study information} block contains global information about the study. It is laid out as in table \ref{table:Study Information}. Note that each cell in the bottom data row row spans all the arms, meaning it is as tall as the number of arms in the study.
\begin{table}[h]
  \small
  \centering
  \caption{Study information}
  \label{table:Study Information}
  \begin{tabular}{|l|l|l|l|l|l|l|l|}
    \hline
    \multicolumn{8}{|l|}{Study Information} \\ \hline
    \multicolumn{8}{|l|}{}                  \\ \hline
    \textbf{ID} & \textbf{addis url} & \textbf{title} & \textbf{group allocation} & \textbf{blinding} & \textbf{status} & \textbf{number of centers} & \textbf{objective} \\ \hline
    text* & URL* & text & text & text & text & number & text \\ \hline
  \end{tabular}
\end{table}

\subsubsection{Population information}
The \texttt{Population information} block contains the indication and eligibility criteria of the study. It is laid out as in table \ref{table:Population information}. Note that the indication information cell in this row spans all the arms, meaning it is as tall as the number of arms in the study.
\begin{table}[h]
  \centering
  \caption{Population information}
  \label{table:Population information}
  \begin{tabular}{|l|l|}
    \hline
    \multicolumn{2}{|l|}{\textbf{Population information}} \\ \hline
    \multicolumn{2}{|l|}{}                                \\ \hline
    \textbf{indication} & \textbf{eligibility criteria}   \\ \hline
    text & text                                           \\ \hline
  \end{tabular}
\end{table}

\subsubsection{Arm information}
The \texttt{Arm information} block contains the title and description of each arm in the study. It is laid out as in table \ref{table:Arm information}. Note that there is one data row per arm, and that there is always a `Overall population' group as well.
\begin{table}[h]
  \centering
  \caption{Arm information}
  \label{table:Arm information}
  \begin{tabular}{|l|l|}
    \hline
    \multicolumn{2}{|l|}{\textbf{Arm information}}  \\ \hline
    \multicolumn{2}{|l|}{}                          \\ \hline
    \textbf{title} & \textbf{description}           \\ \hline
    text (arm 1)& text                              \\ \hline
    ... & ...                                       \\ \hline
    Overall population&                             \\ \hline
  \end{tabular}
\end{table}

\subsubsection{Measurement data}
The \texttt{Measurement data} block contains the measured values for each variable measured in the study. This block is the most complex, with several nested block structures. A full layout can be found in table \ref{table:Full measurement data}. We discuss the composing blocks below.

The measurement data block contains one variable block for each variable, as shown in table \ref{table:Measurement data}. Variable blocks are added horizontally (indicated with the ... column). 

\begin{table}[h]
  \centering
  \caption{Measurement data}
  \small
  \label{table:Measurement data}
  \begin{tabular}{|l|l|l|}
    \hline
    \multicolumn{3}{|l|}{\textbf{Measurement data}}  \\ \hline
    variable block 1 & ... & variable block n  \\ \hline
  \end{tabular}
\end{table}

\subsubsection{Variable block}
A variable block is laid out as in table \ref{table:Variable block}, with a \textit{variable name} cell spanning the block horizontally, (a reference to the name as entered on the `Concepts' sheet). Below each \textit{variable name} cell, there is the \textbf{variable type} header, \textbf{measurement type} header, and any number of measurement moment blocks: one per measurement moment at which the variable was measured. Valid values for the variable type are shown in table \ref{table:Variable types}. Valid values for the measurement type are shown in table \ref{table:Measurement types}.

\begin{table}[h]
  \centering
  \caption{Variable block}
  \small
  \label{table:Variable block}
  \begin{tabular}{|l|l|l|l|l|}
    \hline
    \textbf{variable type} &\textbf{ measurement type} & \multirow{2}{*}{measurement moment block 1} & \multirow{2}{*}{...} &  \multirow{2}{*}{measurement moment block n} \\ \cline{1-2}
    enum & enum & & & \\ \hline
  \end{tabular}
\end{table}

\begin{table}[h]
  \centering
  \caption{Variable types}
  \small
  \label{table:Variable types}
  \begin{tabular}{|l|}
    \hline
    baselineCharacteristic \\ \hline
    endpoint \\ \hline
    adverseEvent \\ \hline
  \end{tabular}
\end{table}


\begin{table}[h]
  \centering
  \caption{Measurement types}
  \small
  \label{table:Measurement types}
  \begin{tabular}{|l|}
    \hline
    dichotomous \\ \hline
    continuous \\ \hline
    survival \\ \hline
  \end{tabular}
\end{table}

\subsubsection{Measurement moment block}
A measurement moment block is laid out as in table \ref{table:Measurement moment block}. It consists of a \textbf{measurement moment} header, followed by one header per measured result property. Under the \textbf{measurement moment} header is the \textit{measurement moment} reference (referring to the `Measurement moments` worksheet), which vertically spans all arm rows. Below each result property header comes one cell per arm, with for each cell the value (if any) measured in the study for that combination of arm, measurement moment and result property.

\begin{table}[h]
  \centering
  \caption{Measurement moment block}
  \small
  \label{table:Measurement moment block}
  \begin{tabular}{|l|l|l|l|}
    \hline
    \textbf{measurement moment} & result property 1 &  ... & result property n \\ \hline
    \multirow{3}{*}{reference} & value & ... & value    \\  \cline{2-4}
                               & value & ... & value    \\  \cline{2-4}
                               & value & ... & value    \\  \cline{2-4}
    \hline
  \end{tabular}
\end{table}

\begin{table}[h]
  \centering
  \caption{Full measurement data}
  \small
  \label{table:Full measurement data}
  \begin{tabular}{|l|l|l|l|l|l|l|}
    \hline
    \multicolumn{7}{|l|}{\textbf{Measurement data}}  \\ \hline
    \multicolumn{6}{|l|}{\textit{variable name}}  & ...  \\ \hline
    \textbf{variable type} &\textbf{ measurement type} & \textbf{measurement moment} & result property 1 &  ... & result property n & ...\\ \hline
    text & text & text & value & ... & value       & ... \\  \cline{4-6} 
         &      &      & ...   & ... & ...        & ...  \\  \cline{4-6} 
         &      &      & value & ... & value      & ...  \\ \hline
  \end{tabular}
\end{table}

\subsection{Activities}
The \texttt{Activities} worksheet stores the actions that were performed in the study. Its most basic layout is shown in table \ref{table:Activities simple}. The possible values for the activity type enum are shown in table \ref{table:activityTypes}.

If any of the activities in the table are a `drug treatment' activity, the table headers should be extended to cover this extra information: for each drug administered, there are the headers \textbf{drug label}, \textbf{dose type}, \textbf{dose}, \textbf{max dose}, \textbf{unit} and \textbf{periodicity}. An example with a drug treatment activity is shown in table \ref{table:Activities complex}. In the drug treatment's row, the \textit{drug label} cell is a reference to the drug's label on the `Concepts' worksheet. The possible values for the \textbf{dose type} column are shown in table \ref{table:Dosage types}. The \textit{unit} cell is a reference to the unit's label on the `Concepts' worksheet. The \textbf{periodicity} cell indicates the interval between each dosage application. The interval's duration is specified in \href{https://en.wikipedia.org/wiki/ISO_8601#Durations}{ISO_8601 duration format}.

\begin{table}[h]
  \centering
  \caption{Activities simple}
  \small
  \label{table:Activities complex}
  \begin{tabular}{|l|l|l|l|}
    \hline
    \textbf{id} & \textbf{title} & \textbf{type} & \textbf{description} \\ \hline
    URI (activity 1) & text           & enum & text \\ \hline
    ...              & ...            & ...  & ...  \\ \hline
    URI (activity n) & text           & enum & text \\ \hline
  \end{tabular}
\end{table}

\begin{table}[h]
  \centering
  \caption{Activity types}
  \small
  \label{table:Activity types}
  \begin{tabular}{|l|}
    \hline
    screening \\ \hline
    wash out \\ \hline
    randomization \\ \hline
    drug treatment \\ \hline
    follow up \\ \hline
    other \\ \hline
  \end{tabular}
\end{table}


\begin{table}[h]
  \centering
  \caption{Dosage types}
  \small
  \label{table:Dosage types}
  \begin{tabular}{|l|}
    \hline
    fixed \\ \hline
    titrated \\ \hline
  \end{tabular}
\end{table}


\begin{table}[h]
  \centering
  \caption{Activities complex}
  \small
  \label{table:Activities complex}
  \begin{tabular}{|l|l|l|l|l|l|l|l|l|l|l|}
    \hline
    \textbf{id}      & \textbf{title} & \textbf{type} & \textbf{description} & \textbf{drug label}   & \textbf{dose type} & \textbf{dose} & \textbf{max dose} & \textbf{unit} & \textbf{periodicity} & ... \\ \hline
    URI (activity 1) & text           & enum          & text                & & & &  & &  & ...\\ \hline
    ...              & ...            & ...           & ...                  & ...                   & ...                & ...           & ...               & ...           & ...   & ...            \\ \hline
    URI (activity n) & text           & enum          & text                & \textit{drug label} & enum               & value         & value             & \textit{unit}          & duration      & ...       \\ \hline
  \end{tabular}
\end{table}

\subsection{Epochs}
The study's temporal structure is described in the \texttt{Epochs} worksheet. Its layout is shown in table \ref{table:Epochs}. An epoch's \textbf{duration} is expressed in \href{https://en.wikipedia.org/wiki/ISO_8601#Durations}{ISO_8601 duration format}. Epochs may be instantaneous, in which case the duration is \texttt{PT0S}.

\begin{table}[!h]
  \centering
  \caption{Epochs}
  \label{table:Epochs}
  \begin{tabular}{|l|l|l|l|l|}
    \hline
    \textbf{id} & \textbf{name} & \textbf{description} & \textbf{duration} & \textbf{isPrimary} \\ \hline
    URI (epoch 1)& text           & text                 & duration                & boolean  \\ \hline
    ...         & ...          & ...                 & ...                & ...  \\ \hline
    URI (epoch n)& text           & text                 & duration                & boolean  \\ \hline
  \end{tabular}
\end{table}

\subsection{Study design}
The layout of the \texttt{Study design} worksheet can be seen in table \ref{table:Study design}.
\begin{table}[!h]
  \centering
  \caption{Study design}
  \label{table:Study design}
  \begin{tabular}{|l|l|l|l|}
    \hline
    \textbf{arm}   & \textit{arm 1}    & ...               & \textit{arm n}    \\ \hline
    \textit{arm 1} & \textit{activity} & \textit{activity} & \textit{activity} \\ \hline
    ...            & \textit{activity} & \textit{activity} & \textit{activity} \\ \hline
    \textit{arm m} & \textit{activity} & \textit{activity} & \textit{activity} \\ \hline
  \end{tabular}
\end{table}

\subsection{Measurement moments}
The layout of the \texttt{Measurement moment} worksheet can be seen in table \ref{table:Measurement moments}.
\begin{table}[!h]
  \centering
  \caption{Measurement moments}
  \label{table:Measurement moments}
  \begin{tabular}{|l|l|l|l|l|}
    \hline
    \textbf{id} & \textbf{name} & \textbf{epoch} & \textbf{from} & \textbf{offset} \\ \hline
    URI         & text          & \textit{epoch} & end/start     & duration        \\ \hline
    ...         & ...           & ...            &  ...          & ...             \\ \hline
    URI         & text          & \textit{epoch} & end/start     & duration        \\ \hline
  \end{tabular}
\end{table}

\subsection{Concepts}
The layout of the \texttt{Concepts} worksheet can be seen in table \ref{table:Concepts}. Note that the \textbf{dataset concept uri} and \textbf{multiplier} columns are only relevant for dataset exports.
\begin{table}[!h]
  \centering
  \caption{Concepts}
  \label{table:Concepts}
  \begin{tabular}{|l|l|l|l|l|}
    \hline
    \textbf{id} & \textbf{label} & \textbf{type} & \textbf{dataset concept uri} & \textbf{multiplier} \\ \hline
    URI         & text           & text          & URI                          & value               \\ \hline
    ...         & ...            & ...           & ...                          & ...                 \\ \hline
    URI         & text           & text          & URI                          & value               \\ \hline
  \end{tabular}
\end{table}

\section{Dataset export}
The dataset export file has the same structure as that of the study export. However, there is data for multiple studies per worksheet, and there are two extra worksheets with additional dataset information, \texttt{Dataset information} and \texttt{Dataset concepts}. In each original sheet, each study is separated by a row of white space. In all but the \texttt{Study data} sheet, the data for a study is preceeded by a \textit{reference} to the id of the corresponding study.\\
In order to handle studies that measure difference variable we let each study have its own variables. We currently do not harmonise across the entire dataset. In the future options such as concept selection might considered.

\subsection{Dataset information}
The layout of the \texttt{Dataset information} worksheet can be seen in table \ref{table:Dataset information}.
\begin{table}[!h]
  \centering
  \caption{Dataset information}
  \label{table:Dataset information}
  \begin{tabular}{|l|l|l|}
    \hline
    \textbf{title} & \textbf{ADDIS url} & \textbf{description} \\ \hline
    text           & URL                & text                 \\ \hline
  \end{tabular}
\end{table}

\subsection{Dataset concepts}
The layout of the \texttt{Dataset concepts} worksheet can be seen in table \ref{table:Dataset concepts}.
\begin{table}[!h]
  \centering
  \caption{Dataset concepts}
  \label{table:Dataset concepts}
  \begin{tabular}{|l|l|l|}
    \hline
    \textbf{id} & \textbf{label} & \textbf{type} \\ \hline
    URI         & text           & text          \\ \hline
    ...         & ...            & ...           \\ \hline
    URI         & text           & text          \\ \hline
  \end{tabular}
\end{table}

\end{document}          
